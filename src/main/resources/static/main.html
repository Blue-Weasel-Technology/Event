<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NearMe</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Date Range Picker CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

  <!-- Link to External Stylesheet -->
  <link rel="stylesheet" href="styles.css" />
</head>

<body>

  <div class="container">
    <!-- Left Panel: Title + Filters -->
    <div class="left-panel">
      <img src="https://i.ibb.co/Kc1nQCcR/Layer-4.png" alt="NearMe Events Logo" class="logo" />

      <div class="filters-container">
        <input type="search" id="filterName" placeholder="Filter by event name or location" />
        <select id="filterStyle">
        <option value="All">All</option>
        <option value="Blues">Blues</option>
        <option value="Boardgames">Boardgames</option>
        <option value="Clasica">Clasica</option>
        <option value="Conferinte">Conferinte</option>
        <option value="Colinde">Colinde</option>
        <option value="Electronica">Electronica</option>
        <option value="Folk">Folk</option>
        <option value="Hip Hop">Hip Hop</option>
        <option value="Jazz">Jazz</option>
        <option value="Party">Party</option>
        <option value="Manele">Manele</option>
        <option value="Metal">Metal</option>
        <option value="Muzica de Petrecere">Muzica de Petrecere</option>
        <option value="Populara">Populara</option>
        <option value="Pop">Pop</option>
        <option value="Pop Rock">Pop Rock</option>
        <option value="Reggae">Reggae</option>
        <option value="Rock">Rock</option>
        <option value="Trap">Trap</option>
        <option value="World Music">World Music</option>
      </select>

        <div class="filters">
        <input type="radio" id="filterToday" name="dateFilter" value="today">
        <label for="filterToday">Today</label>
        <input type="radio" id="filterWeek" name="dateFilter" value="week">
        <label for="filterWeek">This Week</label>
        <input type="radio" id="filterMonth" name="dateFilter" value="month">
        <label for="filterMonth">This Month</label>
      </div>

        <input type="text" id="daterangePicker" />
        <button id="clearFiltersButton">Clear Filters</button>
        <button id="closestEventsButton">Closest Events</button>
      </div>
      
    </div>
    <!-- Modal HTML -->
    <div id="eventModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modalContent"></div>
      </div>
    </div>

    <!-- Right Panel: Map -->
    <div id="map"></div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
        // Get the modal
    const modal = document.getElementById("eventModal");
    const modalContent = document.getElementById("modalContent");
    const closeBtn = document.querySelector(".close");

    // Function to open the modal with event details
    function openModal(eventData) {
      const content = `
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: flex-start; padding: 20px; background-color: #f1f1f1; overflow: hidden; max-width: 100%; box-sizing: border-box;">
        <div style="flex: 0 0 200px; margin-right: 20px; overflow: hidden;">
            <img src="${eventData.image}" alt="${eventData.name}" style="width: 100%; height: auto; object-fit: cover; border-radius: 8px;">
        </div>
        <div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-start; max-width: 100%;">
            <h2 style="font-size: 24px; font-weight: bold; margin: 0; flex: 1;">${eventData.name}</h2>
            <!-- Buy Tickets Button -->
            <button onclick="window.open('${eventData.link}', '_blank')" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 10px;">
                Buy Tickets
            </button>
        </div>
    </div>
    <div class="modal-body" style="padding: 20px; text-align: left; max-width: 600px; margin: 0 auto; overflow: hidden;">
        <div style="margin-bottom: 15px;">
            <strong>Date:</strong> ${moment(eventData.eventDateTime).format('DD/MM/YYYY HH:mm')}
        </div>

        <div style="margin-bottom: 15px;">
            ${eventData.description ? eventData.longDescription : 'No description available'}
        </div>
    </div>
`;
      modalContent.innerHTML = content;
      modal.style.display = "block";

      const currentCenter = map.getCenter();
      const newCenter = L.latLng(eventData.latitude, eventData.longitude);  
      
      const offset = [0, 0.1]; 

      map.setView([newCenter.lat + offset[0], newCenter.lng + offset[1]], 12);  
    }
    // Close modal on clicking the close button
    closeBtn.onclick = function () {
      modal.style.display = "none"; // Hide modal
      modalContent.innerHTML = ''; // Clear previous content
    };

    // Close modal when clicking outside of the modal
    window.onclick = function (event) {
      if (event.target === modal) {
        modal.style.display = "none"; // Hide modal
        modalContent.innerHTML = ''; // Clear previous content
      }
    };

    const map = L.map('map', { attributionControl: false, worldCopyJump: true});
    const customIcon = L.icon({
      iconUrl: 'https://i.ibb.co/5WKs1jDz/Layer-2.png',
      iconSize: [25, 40],
      iconAnchor: [13, 40],
      popupAnchor: [0, -56]
    });

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    let markers = [];
    let currentStartDate = null;
    let currentEndDate = null;

    function buildPopupContent(ev, idx, total, lat, lon) {
  return `
    <div style="display: flex; max-width: 350px; cursor: pointer;" onclick='openModal(${JSON.stringify(ev)})'>
      <div style="flex: 0 0 144px; margin-right: 10px;">
        <img src="${ev.image}" alt="${ev.name}" 
             style="width: 154px; height: 204px; object-fit: cover; border-radius: 4px;">
      </div>
      <div style="flex: 1; display: flex; flex-direction: column; min-height: 204px; position: relative;">
        
        <!-- Event title -->
        <div style="font-weight: bold; font-size: 16px; margin-bottom: 8px;">
          ${ev.name}
        </div>
        
        <!-- Event description -->
        <div style="color: #555; font-size: 14px; margin-bottom: 8px; flex-grow: 1;">
          ${ev.description ? ev.description : 'No description available'}
        </div>
        
        <!-- Event date -->
        <div style="color: #555; font-size: 14px; margin-bottom: 8px;">
          ${moment(ev.eventDateTime).format('DD/MM/YYYY HH:mm')}
        </div>
        
        <!-- Navigation & index pinned to bottom -->
        ${total > 1 ? `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 8px; border-top: 1px solid #ddd;">
          <button onclick="event.stopPropagation(); window.cycleEvent(${lat}, ${lon}, -1)">⟵</button>
          <span style="font-size: 13px; color: #333;">${idx + 1} / ${total}</span>
          <button onclick="event.stopPropagation(); window.cycleEvent(${lat}, ${lon}, 1)">⟶</button>
        </div>
        ` : ''}
      </div>
    </div>
  `;
}

fetch('/events')
  .then(r => r.json())
  .then(events => {
    const grouped = {};
    events.forEach(event => {
      const lat = event.latitude, lon = event.longitude;
      if (lat && lon) {
        const key = `${lat},${lon}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(event);
      }
    });

    Object.values(grouped).forEach(groupEvents => {
      const lat = groupEvents[0].latitude;
      const lon = groupEvents[0].longitude;

      const iconUrl = groupEvents.length > 1 
        ? 'https://i.ibb.co/ty6bzbz/Multi-Events.png'
        : 'https://i.ibb.co/5WKs1jDz/Layer-2.png';

      const iconSize = groupEvents.length > 1 
        ? [45, 42]
        : [25, 40];

      const iconAnchor = groupEvents.length > 1 
        ? [23, 42]
        : [13, 40];

      const popupAnchor = groupEvents.length > 1 
        ? [0, -56]
        : [0, -56];
        
      const customIcon = L.icon({
        iconUrl,
        iconSize,
        iconAnchor,
        popupAnchor
      });

      const marker = L.marker([lat, lon], { icon: customIcon }).addTo(map);
      marker.groupEvents = groupEvents;
      marker.currentIndex = 0;

      marker.bindPopup(buildPopupContent(groupEvents[0], 0, groupEvents.length, lat, lon),{maxWidth: 600, maxHeight: 400});
      marker.on('mouseover', function () { this.openPopup(); });
      marker.on('click', function () {
  openModal(marker.groupEvents[marker.currentIndex]); // opens your sidebar/modal
});

      markers.push({ event: groupEvents[0], marker, groupEvents });
    });

    window.cycleEvent = function(lat, lon, direction) {
      const markerObj = markers.find(m => m.marker.getLatLng().lat === lat && m.marker.getLatLng().lng === lon);
      if (!markerObj) return;

      const marker = markerObj.marker;
      let idx = marker.currentIndex + direction;
      if (idx < 0) idx = marker.groupEvents.length - 1;
      if (idx >= marker.groupEvents.length) idx = 0;

      marker.currentIndex = idx;
      marker.setPopupContent(buildPopupContent(marker.groupEvents[idx], idx, marker.groupEvents.length, lat, lon));
      marker.openPopup();
    };

    filterEvents();
  })
  .catch(err => console.error('Failed to load events:', err));

    $('#daterangePicker').daterangepicker({
      autoUpdateInput: false, opens: 'left',
      locale: { format: 'DD/MM/YYYY', cancelLabel: 'Clear' }
    });
    $('#daterangePicker').on('apply.daterangepicker', function (ev, picker) {
      currentStartDate = picker.startDate.startOf('day').toDate();
      currentEndDate = picker.endDate.endOf('day').toDate();
      $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
      document.querySelectorAll('input[name="dateFilter"]').forEach(rb => rb.checked = false);
      filterEvents();
    });
    $('#daterangePicker').on('cancel.daterangepicker', function () {
      $(this).val('');
      currentStartDate = null;
      currentEndDate = null;
      filterEvents();
    });

    const setDateRangePicker = (start, end) => {
      $('#daterangePicker').data('daterangepicker').setStartDate(start);
      $('#daterangePicker').data('daterangepicker').setEndDate(end);
      $('#daterangePicker').val(start.format('DD/MM/YYYY') + ' - ' + end.format('DD/MM/YYYY'));
      currentStartDate = start.startOf('day').toDate();
      currentEndDate = end.endOf('day').toDate();
    };

    document.getElementById('filterToday').addEventListener('change', () => {
      if (document.getElementById('filterToday').checked) {
        const today = moment();
        setDateRangePicker(today, today);
        filterEvents();
      }
    });
    document.getElementById('filterWeek').addEventListener('change', () => {
      if (document.getElementById('filterWeek').checked) {
        const today = moment(), endOfWeek = moment().add(6, 'days');
        setDateRangePicker(today, endOfWeek);
        filterEvents();
      }
    });
    document.getElementById('filterMonth').addEventListener('change', () => {
      if (document.getElementById('filterMonth').checked) {
        const today = moment(), endOfMonth = moment().add(29, 'days');
        setDateRangePicker(today, endOfMonth);
        filterEvents();
      }
    });

    const filterEvents = () => {
      const searchTerm = document.getElementById('filterName').value.toLowerCase().trim();
      const selectedStyle = document.getElementById('filterStyle').value;

      const visibleMarkers = [];

      markers.forEach(({ event, marker }) => {
        const eventDate = new Date(event.eventDateTime);
        let showEvent = true;

        // Search filter (now matches name OR location)
        if (searchTerm) {
          const nameMatch = event.name && event.name.toLowerCase().includes(searchTerm);
          const locationMatch = event.locationDescription && event.locationDescription.toLowerCase().includes(searchTerm);
          if (!nameMatch && !locationMatch) showEvent = false;
        }

        // Date filter
        if (currentStartDate && currentEndDate && (eventDate < currentStartDate || eventDate > currentEndDate)) {
          showEvent = false;
        }

        // Style filter
        if (selectedStyle !== 'All' && (!event.style || event.style.toLowerCase() !== selectedStyle.toLowerCase())) {
          showEvent = false;
        }

        // Show/hide markers
        if (showEvent) {
          if (!map.hasLayer(marker)) map.addLayer(marker);
          visibleMarkers.push(marker);
        } else {
          if (map.hasLayer(marker)) map.removeLayer(marker);
        }
      });

      // Auto zoom to visible markers
      if (visibleMarkers.length > 0) {
        const group = L.featureGroup(visibleMarkers);
        map.fitBounds(group.getBounds().pad(0.2)); // pad so markers aren’t on the edges
      }
    };

    document.getElementById('filterName').addEventListener('input', filterEvents);
    document.getElementById('filterStyle').addEventListener('change', filterEvents);

    document.getElementById('clearFiltersButton').addEventListener('click', () => {
      document.getElementById('filterName').value = '';
      document.getElementById('filterStyle').value = 'All';
      document.querySelectorAll('input[name="dateFilter"]').forEach(rb => rb.checked = false);
      $('#daterangePicker').val('');
      currentStartDate = null;
      currentEndDate = null;
      filterEvents();
    });

  
    const style = document.createElement('style');
    style.innerHTML = `
      .leaflet-popup-content {
        pointer-events: auto !important;
      }
      .leaflet-popup-close-button {
        pointer-events: auto !important;
      }
    `;
    document.head.appendChild(style);

      document.getElementById('closestEventsButton').addEventListener('click', function () {
      if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;


        // Add a marker for the user's location
        L.marker([lat, lon], {
          icon: L.icon({
            iconUrl: 'https://i.ibb.co/Rp9QfZQD/orange-stick-figure-hi.png',
            iconSize: [25, 65],
            iconAnchor: [13, 65],
            popupAnchor: [0, -40],
          }),
        }).addTo(map).bindPopup("You are here").openPopup();

      }, function (error) {
        alert("Error: " + error.message);
      });
    } else {
      alert("Geolocation is not supported by your browser.");
    }
  });
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // distance in km
    }

    // Function to open the popup with the nearest events and pan the map to the event
    function openEventPopup(events, index) {
        const event = events[index];

        const content = `
        <div style="padding: 20px; position: relative;">
            <!-- First Div: Previous, Next Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <!-- Previous Button -->
                <button onclick="navigateEvents(${index - 1})" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                    Previous
                </button>
                
                <!-- Next Button -->
                <button onclick="navigateEvents(${index + 1})" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                    Next
                </button>
            </div>

            <div class="modal-header" style="display: flex; justify-content: flex-start; align-items: flex-start; padding: 20px; background-color: #f1f1f1; overflow: hidden; max-width: 100%; box-sizing: border-box; margin-bottom: 20px;">
                <div style="flex: 0 0 200px; margin-right: 20px; overflow: hidden;">
                    <img src="${event.image}" alt="${event.name}" style="width: 100%; height: auto; object-fit: cover; border-radius: 8px;">
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-start; max-width: 100%;">
                    <h2 style="font-size: 24px; font-weight: bold; margin: 0; flex: 1;">${event.name}</h2>
                    <!-- Buy Tickets Button -->
                    <button onclick="window.open('${event.link}', '_blank')" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 10px;">
                        Buy Tickets
                    </button>
                </div>
            </div>

            <div class="modal-body" style="padding: 20px; text-align: left; max-width: 600px; margin: 0 auto; overflow: hidden;">
              <div style="margin-top: 20px;">
                  <strong>Distance:</strong> ${event.distance.toFixed(2)} km
              </div>
              <div style="margin-bottom: 15px;">
                    <strong>Date:</strong> ${moment(event.eventDateTime).format('DD/MM/YYYY HH:mm')}
                </div>
                
                <div style="margin-bottom: 15px;">
                    ${event.description ? event.longDescription : 'No description available'}
                </div>
              </div>
          </div>
      `;
        
        modalContent.innerHTML = content;
        modal.style.display = "block";

        // Pan and zoom to the event location
        const zoomLevel = 14;  // Zoom in a bit more (adjustable)
        const offset = [0, 0.022];
        map.setView([event.latitude+offset[0], event.longitude+offset[1]], zoomLevel, { animate: true });

        // Close modal on clicking the close button
    closeBtn.onclick = function () {
      modal.style.display = "none"; // Hide modal
      modalContent.innerHTML = ''; // Clear previous content
    };

    // Close modal when clicking outside of the modal
    window.onclick = function (event) {
      if (event.target === modal) {
        modal.style.display = "none"; // Hide modal
        modalContent.innerHTML = ''; // Clear previous content
      }
    };
        // Prevent cycling out of bounds
        window.navigateEvents = function (newIndex) {
            if (newIndex < 0) newIndex = events.length - 1;
            if (newIndex >= events.length) newIndex = 0;
            openEventPopup(events, newIndex);
        };
    }

    // User location handler
    document.getElementById('closestEventsButton').addEventListener('click', function () {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function (position) {
      const userLat = position.coords.latitude;
      const userLon = position.coords.longitude;

      // Add a marker for the user's location
      L.marker([userLat, userLon], {
        icon: L.icon({
          iconUrl: 'https://i.ibb.co/Rp9QfZQD/orange-stick-figure-hi.png',
          iconSize: [25, 65],
          iconAnchor: [13, 65],
          popupAnchor: [0, -40],
        }),
      }).addTo(map).bindPopup("You are here").openPopup();

      // Fetch all events
      fetch('/events')
        .then(r => r.json())
        .then(events => {
          // Apply filters before calculating distances
          const filteredEvents = events.filter(event => {
            const eventDate = new Date(event.eventDateTime);
            let showEvent = true;

            // Filter by name/location search term
            const searchTerm = document.getElementById('filterName').value.toLowerCase().trim();
            if (searchTerm) {
              const nameMatch = event.name && event.name.toLowerCase().includes(searchTerm);
              const locationMatch = event.locationDescription && event.locationDescription.toLowerCase().includes(searchTerm);
              if (!nameMatch && !locationMatch) showEvent = false;
            }

            // Date filter
            if (currentStartDate && currentEndDate && (eventDate < currentStartDate || eventDate > currentEndDate)) {
              showEvent = false;
            }

            // Style filter
            const selectedStyle = document.getElementById('filterStyle').value;
            if (selectedStyle !== 'All' && (!event.style || event.style.toLowerCase() !== selectedStyle.toLowerCase())) {
              showEvent = false;
            }

            return showEvent; // Return filtered events
          });

          // Calculate distance for each event and sort by distance
          const sortedEvents = filteredEvents.map(event => ({
            ...event,
            distance: calculateDistance(userLat, userLon, event.latitude, event.longitude),
          })).sort((a, b) => a.distance - b.distance);  // Sort by distance

          // Open the popup for the closest event
          openEventPopup(sortedEvents, 0);  // Open the first event's popup
        });
    }, function (error) {
      alert("Error: " + error.message);
    });
  } else {
    alert("Geolocation is not supported by your browser.");
  }
});
  </script>
</body>

</html>
